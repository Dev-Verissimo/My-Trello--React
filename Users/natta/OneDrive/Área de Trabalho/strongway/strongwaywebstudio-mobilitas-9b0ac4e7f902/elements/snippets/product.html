{#
	Se nao ha nivel declarado, assume-se que esta
	na pagina de categoria, que, como comeca com
	nivel 2, pede que os produtos sejam nivel 3
#}

{% if not heading_level %}
	{% set heading_level = 'h3' %}
{% endif %}

{% set product_random_id = random() %}

{% set show_schema = settings.show_schema_in_showcase %}

{% set is_product_available = (
	product.stock > 0
	and product.available == 1 
	and product.available_for_purchase == 1
) %}

{%
	if (
		product.upon_request
		and not settings.show_schema_for_upon_request_products
	) or (
		not is_product_available
		and not settings.show_schema_for_unavailable_products
	) or prevent_schema
%}
	{% set show_schema = false %}
{% endif %}

<div
	class="
		product
		{{ (product.images[1] and settings.show_secondary_image) ? 'has-secondary-image' : null }}
		{{ modifier ? 'product--' ~ modifier : null }}
	"
	{% if not prevent_buy %}
		id="product-{{ product_random_id }}"
	{% endif %}
>
	<div class="product__image-outline">
		<a class="product__image-container" href="{{ product.link }}">
			{% set loading = asset('img/loading.gif') %}

			{% set image_size = ( settings.image_size == "full" ) ? "full" : "large" %}
			
			{% if product.images %}
				<img
					{% if prevent_lazy_load %}
						class="product__image product__image--first img-responsive"
						src="{{ product.images[0][image_size] }}"
					{% else %}
						{% if is_slider %}
							class="product__image product__image--first img-responsive"
							data-lazy="{{ product.images[0][image_size] }}"
						{% else %}
							class="product__image product__image--first img-responsive lazy"
							data-original="{{ product.images[0][image_size] }}"
							src="{{ loading }}"
						{% endif %}
					{% endif %}
					alt="{{ product.name }}"
					width="285"
					height="285"
				>
				
				{% if product.images[1] and settings.show_secondary_image %}
					<img
						class="product__image product__image--sec img-responsive"
						data-src="{{ product.images[1][image_size] }}"
						alt="{{ product.name }}"						
						width="285"
						height="285"
					>
				{% endif %}
			{% else %}
				<span class="icon-camera-off product__no-image"></span>
			{% endif %}
			
			{% element 'snippets/labels' {"product": product} %}
		</a>
	</div>

	<div class="product__info">
		<div class="product__info-inner">
			<div class="product__name-container">
				<{{heading_level}} class="product__name">
					<a
						class="product__link"
						href="{{ product.link }}"
					>
						{{ product.name }}
					</a>
				</{{heading_level}}>
			</div>
			
			{% if product.additional_message %}
				<div class="product__additional-message">
					{{ product.additional_message }}
				</div>
			{% endif %}

			{% element 'snippets/labels' {
				"product": product,
				"modifier": 'inline'
			} %}

			{% if product.ProgressiveDiscounts and settings.show_progressive_discount_in_showcases %}
				<div class="discounts discounts--small">
					{% for discount in product.ProgressiveDiscounts %}
						{% if discount.tag %}
							<div class="discounts__label">
								<p class="discounts__tag">{{discount.tag}}</p>
							</div>
						{% endif %}
					{% endfor %}
				</div>
			{% endif %}
			
			{% if settings.is_ajax_price_enabled %}
				<div data-module="pricing" data-snippet="snippets/price" data-product-id="{{ product.id }}">
					<img src="{{ asset('img/loading.gif') }}" class="product__price__loader" alt="carregando pre&ccedil;os">
				</div>
			{% else %}
				{% element 'snippets/price' {"product": product} %}
			{% endif %}
			
			{% if not prevent_timer 
				and settings.is_timer_enabled 
				and product.price_offer 
				and product.end_promotion != '0000-00-00' 
				and product.price_offer != '0.00' 
				and product.stock > 0 
				and product.available == 1 
				and product.available_for_purchase == 1 
				and product.upon_request != 1
			%}

				<div id="vue-timer-{{ product_random_id }}" >
					<vue-timer
						:timer_id= "timer_id"
						:end_promotion = "end_promotion"
					></vue-timer>
				</div>
	
				<script>
					g.actions['vue-timer-{{ product_random_id }}'] = function () {
						jQuery(window).on('load', function ($) {
							new Vue({
								el: '#vue-timer-{{ product_random_id }}',
								data: {
									end_promotion: "{{ product.end_promotion }}",
									timer_id: "{{ product_random_id }}"
								}
							})
						})
					}
				</script>
			{% endif %}
			
			{% element 'snippets/rating' {"product": product} %}
		</div>

		{% if settings.is_fast_shopping_enabled %}
			{%
				if not product.is_kit
				and not product.upon_request
				and not prevent_buy
				and is_product_available
			%}
				{# Processamento de dados das variantes #}
				{% set processed_variants = [] %}
				{% for variant in product.variants %}
					{% set single_processed_variant = [] %}
					
					{# Para cada Variante, guarda os valores abaixo #}
					{% set single_processed_variant = single_processed_variant|merge({ ('available') : variant.available }) %}
					{% set single_processed_variant = single_processed_variant|merge({ ('id') : variant.id }) %}
					{% set single_processed_variant = single_processed_variant|merge({ ('stock') : variant.stock }) %}
					{% set single_processed_variant = single_processed_variant|merge({ ('price') : variant.price|currency }) %}
					
					{# Processa os Skus de cada variante #}
					{% set processed_skus = [] %}
					{% for sku in variant.Sku %}
						{% set single_processed_sku = [] %}
						
						{% for sku_key, sku_value in sku %}
							{# Para cada dado dos Skus, converte o encoding para iso-8859-1 #}
							{% set single_processed_sku = single_processed_sku|merge({ (sku_key) : sku_value|convert_encoding('utf-8', 'iso-8859-1') }) %}
						{% endfor %}
						
						{# Une os dados em um unico Sku #}
						{% set processed_skus = processed_skus|merge([single_processed_sku]) %}
					{% endfor %}

					{# Une os valores do Sku em um unico atributo #}
					{% set single_processed_variant = single_processed_variant|merge({ ('Sku') : processed_skus }) %}
					
					{# Une os valores das variantes em um unico objeto #}
					{% set processed_variants = processed_variants|merge([single_processed_variant]) %}
				{% endfor %}

				<div class="product__buy">
					<fast-shopping
						:variants="variants"
						:product_id="product_id"
						:is_https="is_https"
					></fast-shopping>
				</div>

				<script>
					g.actions['product-{{ product_random_id }}'] = function () {
						jQuery(window).on('load', function () {
							new Vue({
								el: '#product-{{ product_random_id }} .product__buy',
								data: {
									variants: {{ processed_variants|json_encode|raw }},
									product_id: {{ product.id }},
									is_https: settings.is_https
								}
							})
						})
					};
				</script>
			{% else %}
				<div class="product__buy">
					<a href="{{ product.link }}" class="bt bt--secondary product__view">Visualizar Produto</a>
				</div>
			{% endif %}
		{% else %}
			<div class="product__buy">
				<a href="{{ product.link }}" class="bt bt--secondary product__view">Visualizar Produto</a>
			</div>
		{% endif %}

		{% if settings.compare and not prevent_buy %}
			{% set compareCSS = 'compare-hidden' %}
				<a
					data-compare="remove"
					href="{{ links.compare_delete ~ product.id }}"
					class="product__compare-link product__compare-link--checked {{ not product.compare ? compareCSS }}"
				>{{ Translation("remover_comparar") }}</a>

				<a
					data-compare="add"
					href="{{ links.compare_add  ~ product.id }}"
					class="product__compare-link {{ product.compare ? compareCSS }}"
				>{{ Translation("comparar_produto") }}</a>
		{% endif %}
	</div>
	
	{% if show_schema %}
		{% element 'snippets/schema-product' {'product': product} %}
	{% endif %}
</div>
